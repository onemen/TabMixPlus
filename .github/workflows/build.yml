name: Build Firefox Extension XPI

on:
  push:
    branches: [ wip/build-xpi ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Get latest tag version
        id: get-version
        run: |
          version=$(git tag --sort=-creatordate | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+' | head -n 1 | cut -c 2-)
          echo "VERSION=$version" >> $GITHUB_ENV

      - name: Generate 8-digit date
        id: get-date
        run: echo "DATE=$(date +'%Y%m%d')" >> $GITHUB_ENV

      - name: Set XPI file name
        run: |
          echo "XPI_NAME=tabmix-dev-build" >> $GITHUB_ENV

      - name: Replace version in install.rdf
        run: |
          sed -i "s/1.0.0-unbundeled/${{ env.VERSION }}-${{ env.DATE }}/" addon/install.rdf

      - name: Upload XPI to Release
        id: upload-artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.XPI_NAME }}
          path: addon/

      - name: Download XPI from Release
        id: download-artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.XPI_NAME }}

      - name: Get Release ID
        id: get_release
        run: |
          RESPONSE=$(curl --silent "https://api.github.com/repos/${{ github.repository }}/releases/tags/dev-build" \
            -H "Authorization: Bearer ${{ secrets.REPO_WORKFLOW_TOKEN }}")
          echo "$RESPONSE"
          RELEASE_ID=$(echo "$RESPONSE" | jq '.id')
          echo "RELEASE_ID=$RELEASE_ID" >> $GITHUB_ENV

      - name: Delete existing asset
        uses: actions/github-script@v7
        with:
          github-token: ${{secrets.REPO_WORKFLOW_TOKEN}}
          script: |
            const { owner, repo } = context.repo
            const releaseId = ${{ env.RELEASE_ID }}
            const assets = await github.rest.repos.listReleaseAssets({
              owner,
              repo,
              release_id: releaseId,
            })
            for (const asset of assets.data) {
              if (asset.name === 'tabmix-dev-build.xpi') {
                await github.rest.repos.deleteReleaseAsset({
                  owner,
                  repo,
                  asset_id: asset.id,
                })
              }
            }

      - name: Move tag to latest commit
        run: |
          git config user.email "tabmix.onemen@gmail.com"
          git config user.name "onemen"
          git push origin :refs/tags/dev-build
          git tag -f dev-build
          git push origin dev-build

      - name: Update release
        uses: actions/github-script@v7
        with:
          github-token: ${{secrets.REPO_WORKFLOW_TOKEN}}
          script: |
            const { owner, repo } = context.repo
            const releaseId = ${{ env.RELEASE_ID }}
            await github.rest.repos.updateRelease({
              owner,
              repo,
              release_id: releaseId,
              tag_name: 'dev-build',
              draft: false,
              make_latest: false,
            })

      - name: Upload new asset
        uses: actions/github-script@v7
        with:
          github-token: ${{secrets.REPO_WORKFLOW_TOKEN}}
          script: |
            const { owner, repo } = context.repo;
            const releaseId = ${{ env.RELEASE_ID }};
            // Use the captured artifact URL
            // const artifactUrl = '${{ steps.upload-artifact.outputs.artifact-url }}/${{ env.XPI_NAME }}.zip';
            const artifactUrl = '${{ steps.upload-artifact.outputs.artifact-url }}';
            const artifactDownloadPath = '${{ steps.download-artifact.outputs.download-path }}/${{ env.XPI_NAME }}.zip';
            const assetName = 'tabmix-dev-build.xpi';

            /*
            const artifactResponse = await fetch("https://api.github.com/repos/onemen/TabMixPlus/actions/artifacts");
            if (!artifactResponse.ok) {
              throw new Error(`Can't find artifact id: ${artifactResponse.statusText}`);
            }
            // const data = await artifactResponse.json();
            // const firstArtifactId = data.artifacts[0].id;
            // const artifactUrl = `https://github.com/onemen/TabMixPlus/actions/artifacts/${firstArtifactId}`
            */

            // Download the artifact
            const response = await fetch(artifactDownloadPath);
            console.log('-------------------------------------------')
            //console.log({firstArtifactId})
            console.log({artifactDownloadPath})
            console.log({artifactUrl})
            // console.log(response)
            console.log('-------------------------------------------')
            if (!response.ok) {
              throw new Error(`downloading artifact failed: ${response.statusText}`);
            }
            const asset = await response.arrayBuffer();
            const assetSize = asset.byteLength;
            const assetContentType = 'application/x-xpinstall';

            // Upload the asset
            await github.rest.repos.uploadReleaseAsset({
              owner,
              repo,
              release_id: releaseId,
              name: assetName,
              data: asset,
              headers: {
                'content-length': assetSize,
                'content-type': assetContentType,
              },
            });